# GitHub Actions workflow for rec-praxis-rlm automated code review and security scanning
name: rec-praxis-rlm Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  code-review:
    name: Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm from source
        run: |
          pip install -e .[all]

      - name: Run code review
        run: |
          # Find all Python files changed in this PR/commit
          git fetch origin ${{ github.base_ref || 'main' }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref || 'main' }}...HEAD | grep '\.py$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Running code review on: $CHANGED_FILES"
            rec-praxis-review $CHANGED_FILES --severity=HIGH --json > code-review-results.json
          else
            echo "No Python files changed"
            echo '{"total_findings": 0, "blocking_findings": 0, "findings": []}' > code-review-results.json
          fi

      - name: Upload code review results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-review-results
          path: code-review-results.json

      - name: Comment PR with findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('code-review-results.json', 'utf8'));

            let comment = `## ðŸ” Code Review Results\n\n`;
            comment += `**Found ${results.total_findings} issue(s), ${results.blocking_findings} blocking**\n\n`;

            if (results.findings.length > 0) {
              comment += `| File | Line | Severity | Issue |\n`;
              comment += `|------|------|----------|-------|\n`;
              for (const finding of results.findings.slice(0, 10)) {
                comment += `| ${finding.file} | ${finding.line || 'N/A'} | ${finding.severity} | ${finding.title} |\n`;
              }
              if (results.findings.length > 10) {
                comment += `\n*...and ${results.findings.length - 10} more*\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm from source
        run: |
          pip install -e .[all]

      - name: Run security audit
        run: |
          # Find all Python files changed
          git fetch origin ${{ github.base_ref || 'main' }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref || 'main' }}...HEAD | grep '\.py$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Running security audit on: $CHANGED_FILES"
            rec-praxis-audit $CHANGED_FILES --fail-on=CRITICAL --json > security-audit-results.json
          else
            echo "No Python files changed"
            echo '{"total_findings": 0, "blocking_findings": 0, "findings": []}' > security-audit-results.json
          fi

      - name: Upload security audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: security-audit-results.json

      - name: Comment PR with security findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('security-audit-results.json', 'utf8'));

            let comment = `## ðŸ”’ Security Audit Results\n\n`;
            comment += `**Found ${results.total_findings} issue(s), ${results.blocking_findings} CRITICAL**\n\n`;

            if (results.findings.length > 0) {
              comment += `| File | Severity | OWASP | CWE | Issue |\n`;
              comment += `|------|----------|-------|-----|-------|\n`;
              for (const finding of results.findings.slice(0, 10)) {
                comment += `| ${finding.file} | ${finding.severity} | ${finding.owasp || 'N/A'} | ${finding.cwe || 'N/A'} | ${finding.title} |\n`;
              }
              if (results.findings.length > 10) {
                comment += `\n*...and ${results.findings.length - 10} more*\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-scan:
    name: Dependency & Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm from source
        run: |
          pip install -e .[all]

      - name: Run dependency & secret scan
        run: |
          # Find changed files for secret scanning
          git fetch origin ${{ github.base_ref || 'main' }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref || 'main' }}...HEAD || true)

          if [ -f "requirements.txt" ]; then
            REQ_ARG="--requirements=requirements.txt"
          else
            REQ_ARG=""
          fi

          if [ -n "$CHANGED_FILES" ]; then
            rec-praxis-deps $REQ_ARG --files $CHANGED_FILES --fail-on=CRITICAL --json > dependency-scan-results.json
          else
            rec-praxis-deps $REQ_ARG --fail-on=CRITICAL --json > dependency-scan-results.json
          fi

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: dependency-scan-results.json

      - name: Comment PR with dependency findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('dependency-scan-results.json', 'utf8'));

            let comment = `## ðŸ“¦ Dependency & Secret Scan Results\n\n`;
            comment += `**CVEs: ${results.cve_count}, Secrets: ${results.secret_count}**\n`;
            comment += `**Dependencies scanned: ${results.dependencies_scanned}, Files scanned: ${results.files_scanned}**\n\n`;

            if (results.findings.length > 0) {
              comment += `| Type | Severity | Issue | Remediation |\n`;
              comment += `|------|----------|-------|-------------|\n`;
              for (const finding of results.findings.slice(0, 10)) {
                const remediation = finding.remediation.substring(0, 50) + '...';
                comment += `| ${finding.type} | ${finding.severity} | ${finding.title} | ${remediation} |\n`;
              }
              if (results.findings.length > 10) {
                comment += `\n*...and ${results.findings.length - 10} more*\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dogfood-examples:
    name: Dogfood on Examples
    runs-on: ubuntu-latest
    # Run on push to main to demonstrate capabilities (not blocking)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm from source
        run: |
          pip install -e .[all]

      - name: Code Review Examples
        run: |
          echo "Running code review on examples/"
          rec-praxis-review examples/*.py \
            --severity=MEDIUM \
            --json > dogfood-code-review-examples.json
        continue-on-error: true

      - name: Security Audit Examples
        run: |
          echo "Running security audit on examples/"
          rec-praxis-audit examples/*.py \
            --fail-on=HIGH \
            --json > dogfood-security-audit-examples.json
        continue-on-error: true

      - name: Dependency Scan
        run: |
          echo "Running dependency scan"
          if [ -f "requirements.txt" ]; then
            rec-praxis-deps --requirements=requirements.txt \
              --files examples/*.py \
              --fail-on=CRITICAL \
              --json > dogfood-dependency-scan.json
          else
            echo '{"note": "No requirements.txt found"}' > dogfood-dependency-scan.json
          fi
        continue-on-error: true

      - name: Upload dogfooding results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dogfood-results-examples
          path: |
            dogfood-*.json

      - name: Display examples dogfooding summary
        if: always()
        run: |
          echo "=== Examples Dogfooding Summary ==="
          echo ""
          echo "Code Review Results:"
          if [ -f dogfood-code-review-examples.json ]; then
            python -c "import json; data=json.load(open('dogfood-code-review-examples.json')); print(f'  Total findings: {data.get(\"total_findings\", 0)}'); print(f'  Blocking: {data.get(\"blocking_findings\", 0)}')"
          fi
          echo ""
          echo "Security Audit Results:"
          if [ -f dogfood-security-audit-examples.json ]; then
            python -c "import json; data=json.load(open('dogfood-security-audit-examples.json')); print(f'  Total findings: {data.get(\"total_findings\", 0)}'); print(f'  Critical: {data.get(\"blocking_findings\", 0)}')"
          fi
          echo ""
          echo "Dependency Scan Results:"
          if [ -f dogfood-dependency-scan.json ]; then
            python -c "import json; data=json.load(open('dogfood-dependency-scan.json')); print(f'  CVEs: {data.get(\"cve_count\", 0)}'); print(f'  Secrets: {data.get(\"secret_count\", 0)}')"
          fi

  dogfood-production:
    name: Dogfood on Production Code
    runs-on: ubuntu-latest
    # Scan production rec_praxis_rlm code to validate tool quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm from source
        run: |
          pip install -e .[all]

      - name: Code Review Production Code
        run: |
          echo "Running code review on production code"
          rec-praxis-review rec_praxis_rlm/**/*.py \
            --severity=MEDIUM \
            --format=json > dogfood-production-review.json
        continue-on-error: true

      - name: Code Review Production Code (TOON format)
        run: |
          echo "Running code review with TOON format"
          rec-praxis-review rec_praxis_rlm/**/*.py \
            --severity=MEDIUM \
            --format=toon > dogfood-production-review-toon.txt
        continue-on-error: true

      - name: Security Audit Production Code
        run: |
          echo "Running security audit on production code"
          rec-praxis-audit rec_praxis_rlm/**/*.py \
            --fail-on=HIGH \
            --format=json > dogfood-production-audit.json
        continue-on-error: true

      - name: Upload production dogfooding results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dogfood-results-production
          path: |
            dogfood-production-*.json
            dogfood-production-*.txt

      - name: Display production dogfooding summary
        if: always()
        run: |
          echo "=== Production Code Dogfooding Summary ==="
          echo ""
          echo "Code Review Results (JSON):"
          if [ -f dogfood-production-review.json ]; then
            python -c "import json; data=json.load(open('dogfood-production-review.json')); print(f'  Total findings: {data.get(\"total_findings\", 0)}'); print(f'  Blocking: {data.get(\"blocking_findings\", 0)}')"
          fi
          echo ""
          echo "Code Review Results (TOON format - token efficient):"
          if [ -f dogfood-production-review-toon.txt ]; then
            wc -c dogfood-production-review-toon.txt | awk '{print "  TOON output size: " $1 " bytes"}'
            wc -c dogfood-production-review.json | awk '{print "  JSON output size: " $1 " bytes"}'
            python -c "
import os
toon_size = os.path.getsize('dogfood-production-review-toon.txt')
json_size = os.path.getsize('dogfood-production-review.json')
if json_size > 0:
    reduction = 100 * (1 - toon_size / json_size)
    print(f'  Token reduction: {reduction:.1f}%')
"
          fi
          echo ""
          echo "Security Audit Results:"
          if [ -f dogfood-production-audit.json ]; then
            python -c "import json; data=json.load(open('dogfood-production-audit.json')); print(f'  Total findings: {data.get(\"total_findings\", 0)}'); print(f'  Critical: {data.get(\"blocking_findings\", 0)}')"
          fi
