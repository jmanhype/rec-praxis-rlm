# GitHub Actions workflow for rec-praxis-rlm automated code review and security scanning
name: rec-praxis-rlm Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  code-review:
    name: Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm
        run: |
          pip install rec-praxis-rlm[all]

      - name: Run code review
        run: |
          # Find all Python files changed in this PR/commit
          git fetch origin ${{ github.base_ref || 'main' }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref || 'main' }}...HEAD | grep '\.py$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Running code review on: $CHANGED_FILES"
            rec-praxis-review $CHANGED_FILES --severity=HIGH --json > code-review-results.json
          else
            echo "No Python files changed"
            echo '{"total_findings": 0, "blocking_findings": 0, "findings": []}' > code-review-results.json
          fi

      - name: Upload code review results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-review-results
          path: code-review-results.json

      - name: Comment PR with findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('code-review-results.json', 'utf8'));

            let comment = `## ðŸ” Code Review Results\n\n`;
            comment += `**Found ${results.total_findings} issue(s), ${results.blocking_findings} blocking**\n\n`;

            if (results.findings.length > 0) {
              comment += `| File | Line | Severity | Issue |\n`;
              comment += `|------|------|----------|-------|\n`;
              for (const finding of results.findings.slice(0, 10)) {
                comment += `| ${finding.file} | ${finding.line || 'N/A'} | ${finding.severity} | ${finding.title} |\n`;
              }
              if (results.findings.length > 10) {
                comment += `\n*...and ${results.findings.length - 10} more*\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm
        run: |
          pip install rec-praxis-rlm[all]

      - name: Run security audit
        run: |
          # Find all Python files changed
          git fetch origin ${{ github.base_ref || 'main' }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref || 'main' }}...HEAD | grep '\.py$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Running security audit on: $CHANGED_FILES"
            rec-praxis-audit $CHANGED_FILES --fail-on=CRITICAL --json > security-audit-results.json
          else
            echo "No Python files changed"
            echo '{"total_findings": 0, "blocking_findings": 0, "findings": []}' > security-audit-results.json
          fi

      - name: Upload security audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: security-audit-results.json

      - name: Comment PR with security findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('security-audit-results.json', 'utf8'));

            let comment = `## ðŸ”’ Security Audit Results\n\n`;
            comment += `**Found ${results.total_findings} issue(s), ${results.blocking_findings} CRITICAL**\n\n`;

            if (results.findings.length > 0) {
              comment += `| File | Severity | OWASP | CWE | Issue |\n`;
              comment += `|------|----------|-------|-----|-------|\n`;
              for (const finding of results.findings.slice(0, 10)) {
                comment += `| ${finding.file} | ${finding.severity} | ${finding.owasp || 'N/A'} | ${finding.cwe || 'N/A'} | ${finding.title} |\n`;
              }
              if (results.findings.length > 10) {
                comment += `\n*...and ${results.findings.length - 10} more*\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-scan:
    name: Dependency & Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install rec-praxis-rlm
        run: |
          pip install rec-praxis-rlm[all]

      - name: Run dependency & secret scan
        run: |
          # Find changed files for secret scanning
          git fetch origin ${{ github.base_ref || 'main' }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref || 'main' }}...HEAD || true)

          if [ -f "requirements.txt" ]; then
            REQ_ARG="--requirements=requirements.txt"
          else
            REQ_ARG=""
          fi

          if [ -n "$CHANGED_FILES" ]; then
            rec-praxis-deps $REQ_ARG --files $CHANGED_FILES --fail-on=CRITICAL --json > dependency-scan-results.json
          else
            rec-praxis-deps $REQ_ARG --fail-on=CRITICAL --json > dependency-scan-results.json
          fi

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: dependency-scan-results.json

      - name: Comment PR with dependency findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('dependency-scan-results.json', 'utf8'));

            let comment = `## ðŸ“¦ Dependency & Secret Scan Results\n\n`;
            comment += `**CVEs: ${results.cve_count}, Secrets: ${results.secret_count}**\n`;
            comment += `**Dependencies scanned: ${results.dependencies_scanned}, Files scanned: ${results.files_scanned}**\n\n`;

            if (results.findings.length > 0) {
              comment += `| Type | Severity | Issue | Remediation |\n`;
              comment += `|------|----------|-------|-------------|\n`;
              for (const finding of results.findings.slice(0, 10)) {
                const remediation = finding.remediation.substring(0, 50) + '...';
                comment += `| ${finding.type} | ${finding.severity} | ${finding.title} | ${remediation} |\n`;
              }
              if (results.findings.length > 10) {
                comment += `\n*...and ${results.findings.length - 10} more*\n`;
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
